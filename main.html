<!doctype html>
<html lang="en">
  <head>
     <base target="_self">
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <style>
    .nav-link{
      cursor:pointer;      
    }
    .form-control{
      position:right;
    }
    #loading {
      position:fixed;
      top:0;
      left:0;
      z-index:10000;
      width:100vw;
      height:100vh;
      background: rgba(255,255,255,0.9);
    
    }
    </style>

  </head>
  <body>
  <div class="container">
    <nav id="navigation" class="mb-3">
      <ul class="nav nav-tabs main-nav">        
          <li class="nav-item">
            <div class="nav-link active" id="search-link">Find Customer</div>
          </li>
          <li class="nav-item">
            <div class="nav-link" id="add-customer-link">Add Customer</div>
          </li>
             
        <div class="nav-item input-field col s6">
              <button class="btn btn-primary btn-lg btn-block align-middle" id="btn">Add</button>         
          </div>
           <div class="input-group input-group-sm mb-3 input-field col s6" role="alert">   
                 <input id="input0" type="text" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm" class="input-group-text validate"> 
            </div>  
       </ul>
         
    </nav>
  

  <div id="app"></div>
  <!-- Content here -->  
  </div>
  
  <div id="loading" class="d-flex justify-content-center align-items-center invisible">
   <div>
      <div class="spinner-border text-info" style="width: 4rem; height: 4rem;" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
  </div>
  
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
  <script>
  var data;
  
  function loadView(options){
   
    var id = typeof options.id === "undefined" ? "app" : options.id;
    var cb = typeof options.callback === "undefined" ? function(){} : options.callback;
     loadingStart();
    google.script.run.withSuccessHandler(function(html){
        document.getElementById(id).innerHTML = html;
     loadingEnd();
        typeof options.params === "undefined" ? cb() : cb(options.params);
    })[options.func]();
  }
  
  
  
  
  
  var initVal = <?= initialValue ?>;
       if(initVal <= 0){
     document.getElementById("input0").classList.add("text-danger");
        }
        else{
        document.getElementById("input0").classList.add("text-success");
       
   }
        document.getElementById("input0").value = initVal;
        
         loadingStart();
         google.script.run.withSuccessHandler(showValue).getNewValue();
          loadingEnd();
        
         
        
     
         
   function showValue(myValue){
         document.getElementById("input0").value = myValue;
  
    
       
};
  
 
         
         
  
  function setDataForSearch(){
    loadingStart();
    google.script.run.withSuccessHandler(function(dataReturned){
       data = dataReturned.slice();
    loadingEnd();
    }).getDataForSearch();
  }
  
  function loadSearchView(){
    loadView({func: "loadSearchView", callback: setDataForSearch});
  }
  
  function search(){
    var searchInput = document.getElementById("searchInput").value.toString().toLowerCase().trim();
    var searchWords = searchInput.split(/\s+/);
    var searchColumns = [1,2];
    // and or 
    
    var resultsArray = searchInput === "" ? [] : data.filter(function(r){ 
       return   searchWords.every(function(word){
              return searchColumns.some(function(colIndex){
                return  r[colIndex].toString().toLowerCase().indexOf(word) !== -1
             });
          });
    });
    var searchResultBox = document.getElementById("searchResults");
    var templateBox = document.getElementById("rowTemplate");
    var template = templateBox.content;
    
    searchResultBox.innerHTML="";
    
    resultsArray.forEach(function(r){
    
       var tr = template.cloneNode(true);
       var custIDColumn = tr.querySelector(".custID");
       var firstNameColumn = tr.querySelector(".firstName");
       var lastNameColumn = tr.querySelector(".lastName");
       var deleteButton = tr.querySelector(".delete-button");
       var editButton = tr.querySelector(".edit-button");
       
       
       custIDColumn.textContent = r[0];
       deleteButton.dataset.customerId = r[0];
       editButton.dataset.customerId = r[0];
       firstNameColumn.textContent = r[1];
       lastNameColumn.textContent = r[2];
       searchResultBox.appendChild(tr);
       
    });
   }

  function displayConfirmationDelete(e){
    if(e.target.dataset.buttonState === "delete"){
      e.target.previousElementSibling.classList.remove("d-none");
      e.target.textContent ="Cancel";
      e.target.dataset.buttonState = "cancel";
     } else {
     
      e.target.previousElementSibling.classList.add("d-none");
      e.target.textContent ="Delete";
      e.target.dataset.buttonState = "delete";
     
     }
   }

  function deleteCustomer(e){
    var custID = e.target.dataset.customerId;
    loadingStart();
    google.script.run.withSuccessHandler(function(){
      e.target.closest(".result-box").remove();
      var ids = data.map(function(r){ return r[0].toString().toLowerCase() });
      var index = ids.indexOf(custID.toString().toLowerCase());
      data.splice(index, 1);
      loadingEnd();
    }).deleteById(custID);
  
  }

  function afterEditViewLoads(params){
    //{custID: 32}  
    loadingStart();
    document.getElementById("customer-id").value = params.custID;
    google.script.run.withSuccessHandler(function(customerInfo){
    
      document.getElementById("first-name").value = customerInfo.firstName;
      document.getElementById("last-name").value = customerInfo.lastName;
      document.getElementById("phone-number").value = customerInfo.phone;
      loadingEnd();
    }).getCustomerById(params.custID);
  }

  function editCustomer(){
     loadingStart();
    var customerInfo = {};
    customerInfo.firstName = document.getElementById("first-name").value;
    customerInfo.lastName = document.getElementById("last-name").value;
    customerInfo.phone = document.getElementById("phone-number").value;
    
    var id = document.getElementById("customer-id").value;
    
    google.script.run.withSuccessHandler(function(res){
      document.getElementById("save-success-message").classList.remove("invisible");
      loadingEnd();
      setTimeout(function(){
        document.getElementById("save-success-message").classList.add("invisible");
      },2000)
     }).editCustomerById(id, customerInfo);  
    }
  
  
  function addCustomer(){
     loadingStart();
     var customerInfo = {};
          customerInfo.firstName = document.getElementById("first-name").value;
          customerInfo.lastName = document.getElementById("last-name").value;
          customerInfo.phone = document.getElementById("phone-number").value;
  
  
    google.script.run.withSuccessHandler(function(){
        document.getElementById("first-name").value = "";
        document.getElementById("last-name").value = "";
        document.getElementById("phone-number").value = "";
        
        document.getElementById("save-success-message").classList.remove("invisible");
        loadingEnd();
        setTimeout(function(){
          document.getElementById("save-success-message").classList.add("invisible");
          },2000)
    
    }).addCustomer(customerInfo);
  
  
  }
  

  function loadSearchView(){
    loadView({func: "loadSearchView", callback: setDataForSearch });
  }

  function loadAddCustomerView(){
    loadView({func: "loadAddCustomersView"});
  }
  function loadEditCustomerView(e){
    loadView({func: "loadEditCustomersView", callback: afterEditViewLoads, params: {custID: e.target.dataset.customerId} });
  }
  
  function loadNValue(e){
    loadView({func: "loadNewValue", params: {custID: e.target.dataset.customerId} });
  }
  
  
  function activeTabChange(e){
  
    var navLinks = document.querySelectorAll(".main-nav .nav-link");      
    navLinks.forEach(function(linkEl){
       linkEl.classList.remove("active");
      });
      e.target.classList.add("active");
  }
  
  function loadingStart(){
    document.getElementById("loading").classList.remove("invisible");
  }
  
  function loadingEnd(){
    document.getElementById("loading").classList.add("invisible");
  }
  
  
  document.getElementById("search-link").addEventListener("click",loadSearchView);
  document.getElementById("add-customer-link").addEventListener("click",loadAddCustomerView);
  
  
  function inputEventHandler(e){
    if(e.target.matches("#searchInput")){
      search();
     }
  }
  
  function clickEventHandler(e){
    if(e.target.matches(".delete-button")){
      deleteCustomer(e);
     }
    if(e.target.matches(".before-delete-button")){
      displayConfirmationDelete(e);
     }
    if(e.target.matches(".edit-button")){
      loadEditCustomerView(e);
     }
     if(e.target.matches("#save-changes")){
      editCustomer();
     }
     if(e.target.matches("#cancel-changes")){
      loadSearchView();
     }
     if(e.target.matches("#add-customer-button")){
      addCustomer();
     }
     add-customer-button
  }
  
  function navClickEventHandler(e){
    if(e.target.matches(".nav-link")){
        activeTabChange(e);
     }  
  }
  document.getElementById("app").addEventListener("input",inputEventHandler);
  document.getElementById("app").addEventListener("click",clickEventHandler);
  document.getElementById("navigation").addEventListener("click",navClickEventHandler);  
  document.addEventListener("DOMContentLoaded",loadSearchView);
  </script>
  
  </body>
</html>
